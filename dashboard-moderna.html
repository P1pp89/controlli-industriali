<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè≠ Dashboard Controlli Industriali</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #334155;
        }
        
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 0 2rem;
        }
        
        .nav-tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .nav-tab:hover {
            background: #f1f5f9;
        }
        
        .nav-tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        
        .main-content {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3b82f6;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }
        
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè≠ Dashboard Controlli Industriali</h1>
        <p>Sistema di gestione controlli impianti tecnici</p>
    </div>

    <div class="nav-tabs">
        <div class="nav-tab active" onclick="showTab('overview')">üìä Panoramica</div>
        <div class="nav-tab" onclick="showTab('operators')">üë• Operatori</div>
        <div class="nav-tab" onclick="showTab('rooms')">üè≠ Impianti</div>
        <div class="nav-tab" onclick="showTab('unknown-tags')">üîç Tag Sconosciuti</div>
        <div class="nav-tab" onclick="showTab('config')">‚öôÔ∏è Configurazione</div>
        <div class="nav-tab" onclick="showTab('reports')">üìã Report</div>
    </div>

    <div class="main-content">
        <!-- TAB PANORAMICA -->
        <div id="overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalOperators">-</div>
                    <div class="stat-label">Operatori Attivi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRooms">-</div>
                    <div class="stat-label">Impianti Configurati</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayControls">-</div>
                    <div class="stat-label">Controlli Oggi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingTags">-</div>
                    <div class="stat-label">Tag in Attesa</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Controlli Recenti</h3>
                    <button class="btn btn-primary" onclick="refreshData()">üîÑ Aggiorna</button>
                </div>
                <div id="recentControls" class="loading">Caricamento...</div>
            </div>
        </div>

        <!-- TAB OPERATORI -->
        <div id="operators" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Gestione Operatori</h3>
                    <button class="btn btn-success" onclick="showAddOperatorModal()">‚ûï Nuovo Operatore</button>
                </div>
                <div id="operatorsList" class="loading">Caricamento operatori...</div>
            </div>
        </div>

        <!-- TAB IMPIANTI -->
        <div id="rooms" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Impianti Tecnici</h3>
                    <button class="btn btn-success" onclick="showAddRoomModal()">‚ûï Nuovo Impianto</button>
                </div>
                <div id="roomsList" class="loading">Caricamento impianti...</div>
            </div>
        </div>

        <!-- TAB TAG SCONOSCIUTI -->
        <div id="unknown-tags" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Tag Sconosciuti</h3>
                    <button class="btn btn-primary" onclick="loadUnknownTags()">üîÑ Aggiorna</button>
                </div>
                <div id="unknownTagsList" class="loading">Caricamento tag sconosciuti...</div>
            </div>
        </div>

        <!-- TAB CONFIGURAZIONE -->
        <div id="config" class="tab-content">
            <h2>‚öôÔ∏è Configurazione Sistema</h2>
            
            <!-- Gestione Tag/Impianti -->
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="card-title">üè∑Ô∏è Gestione Tag e Impianti</h3>
                    <button onclick="showAddRoomModal()" style="background: #4CAF50; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                        ‚ûï Nuovo Impianto
                    </button>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="margin-bottom: 1rem;">
                        <input type="text" id="searchRooms" placeholder="üîç Cerca impianti..." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" onkeyup="filterRooms()">
                    </div>
                    <div id="roomsConfigList" style="max-height: 400px; overflow-y: auto;">
                        <div style="text-align: center; padding: 2rem; color: #666;">Caricamento impianti...</div>
                    </div>
                </div>
            </div>

            <!-- Gestione Categorie -->
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="card-title">üìÇ Gestione Categorie</h3>
                    <button onclick="showAddCategoryModal()" style="background: #2196F3; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                        ‚ûï Nuova Categoria
                    </button>
                </div>
                <div style="padding: 1.5rem;">
                    <div id="categoriesList">
                        <div style="text-align: center; padding: 2rem; color: #666;">Caricamento categorie...</div>
                    </div>
                </div>
            </div>

            <!-- Gestione Operatori -->
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="card-title">üë• Gestione Operatori</h3>
                    <button onclick="showAddOperatorModal()" style="background: #FF9800; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                        ‚ûï Nuovo Operatore
                    </button>
                </div>
                <div style="padding: 1.5rem;">
                    <div id="operatorsConfigList">
                        <div style="text-align: center; padding: 2rem; color: #666;">Caricamento operatori...</div>
                    </div>
                </div>
            </div>

            <!-- Configurazione Azienda -->
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="card-title">üè¢ Configurazione Azienda</h3>
                    <button onclick="showCompanyConfigModal()" style="background: #8e44ad; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                        ‚öôÔ∏è Modifica Dati
                    </button>
                </div>
                <div style="padding: 1.5rem;">
                    <div id="companyConfigDisplay">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <strong>Azienda:</strong> <span id="displayCompanyName">LA TUA AZIENDA S.R.L.</span><br>
                                <strong>Responsabile Tecnico:</strong> <span id="displayTechnicalManager">Ing. Mario Rossi</span><br>
                                <strong>Resp. Manutenzione:</strong> <span id="displayMaintenanceManager">Geom. Luigi Bianchi</span>
                            </div>
                            <div>
                                <strong>Indirizzo:</strong> <span id="displayAddress">Via Esempio 123, Roma</span><br>
                                <strong>Telefono:</strong> <span id="displayPhone">+39 06 1234567</span><br>
                                <strong>Email:</strong> <span id="displayEmail">info@tuaazienda.it</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB REPORT -->
        <div id="reports" class="tab-content">
            <!-- Sezione Controlli Report -->
            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 class="card-title">üìÖ Controlli e Filtri</h3>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="font-weight: bold; margin-bottom: 0.5rem; display: block;">üìÖ Data Inizio:</label>
                            <input type="date" id="reportStartDate" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="font-weight: bold; margin-bottom: 0.5rem; display: block;">üìÖ Data Fine:</label>
                            <input type="date" id="reportEndDate" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="font-weight: bold; margin-bottom: 0.5rem; display: block;">üë§ Operatore:</label>
                            <select id="reportOperator" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px;">
                                <option value="">Tutti gli operatori</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: bold; margin-bottom: 0.5rem; display: block;">üïê Turno:</label>
                            <select id="reportShift" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px;">
                                <option value="">Tutti i turni</option>
                                <option value="morning">Mattino (06-14)</option>
                                <option value="afternoon">Pomeriggio (14-22)</option>
                                <option value="night">Notte (22-06)</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: bold; margin-bottom: 0.5rem; display: block;">üè≠ Categoria:</label>
                            <select id="reportCategory" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px;">
                                <option value="">Tutte le categorie</option>
                                <option value="elettrico">‚ö° Impianti Elettrici</option>
                                <option value="antincendio">üî• Antincendio</option>
                                <option value="hvac">‚ùÑÔ∏è HVAC</option>
                                <option value="ups">üîã UPS</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sezione Registri Professionali -->
            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 class="card-title">üìã Registri Professionali</h3>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <button onclick="generateProfessionalElectricalRegister()" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; border: none; padding: 1rem 1.5rem; border-radius: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(243,156,18,0.3); transition: all 0.3s;">
                            ‚ö° Registro Impianti Elettrici
                        </button>
                        <button onclick="generateProfessionalFireRegister()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; padding: 1rem 1.5rem; border-radius: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(231,76,60,0.3); transition: all 0.3s;">
                            üî• Registro Antincendio
                        </button>
                        <button onclick="generateProfessionalHVACRegister()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; border: none; padding: 1rem 1.5rem; border-radius: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(52,152,219,0.3); transition: all 0.3s;">
                            ‚ùÑÔ∏è Registro HVAC
                        </button>
                        <button onclick="generateProfessionalUPSRegister()" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; border: none; padding: 1rem 1.5rem; border-radius: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(39,174,96,0.3); transition: all 0.3s;">
                            üîã Registro UPS
                        </button>
                        <button onclick="generateProfessionalCompleteRegister()" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; border: none; padding: 1rem 1.5rem; border-radius: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(155,89,182,0.3); transition: all 0.3s;">
                            üìä Registro Completo
                        </button>
                        <button onclick="generateProfessionalShiftRegister()" style="background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); color: white; border: none; padding: 1rem 1.5rem; border-radius: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(52,73,94,0.3); transition: all 0.3s;">
                            üïê Registro per Turni
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sezione Report Classici -->
            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 class="card-title">üìÑ Report Classici</h3>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button onclick="generateShiftRegister()" style="background: #2196F3; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                            üìÖ Report Turni Semplice
                        </button>
                        <button onclick="generateElectricalRegister()" style="background: #FF9800; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                            ‚ö° Report Elettrico Semplice
                        </button>
                        <button onclick="generateSignedReport()" style="background: #4CAF50; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                            üñäÔ∏è Report con Firme
                        </button>
                        <button onclick="generateFullReport()" style="background: #9C27B0; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                            üìä Report Completo
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìà Statistiche Avanzate</h3>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #2196F3;" id="totalControlsMonth">-</div>
                            <div style="color: #666;">Controlli Mese</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #4CAF50;" id="avgControlsDay">-</div>
                            <div style="color: #666;">Media Giornaliera</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #FF9800;" id="mostActiveOperator">-</div>
                            <div style="color: #666;">Operatore Top</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #9C27B0;" id="mostControlledRoom">-</div>
                            <div style="color: #666;">Impianto Top</div>
                        </div>
                    </div>
                    <button onclick="loadAdvancedStats()" style="background: #607D8B; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                        üîÑ Aggiorna Statistiche
                    </button>
                </div>
            </div>

            <!-- Area Preview Report -->
            <div id="reportPreview" style="display: none;">
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 class="card-title">üëÅÔ∏è Anteprima Report</h3>
                        <div>
                            <button onclick="printReport()" style="background: #4CAF50; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;">
                                üñ®Ô∏è Stampa
                            </button>
                            <button onclick="closeReportPreview()" style="background: #f44336; color: white; border: none; padding: 0.5rem 1.5rem; border-radius: 4px; cursor: pointer;">
                                ‚úñÔ∏è Chiudi
                            </button>
                        </div>
                    </div>
                    <div id="reportContent" style="padding: 1.5rem; background: white; max-height: 600px; overflow-y: auto;">
                        <!-- Contenuto report generato dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL AGGIUNGI/MODIFICA IMPIANTO -->
    <div id="roomModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="roomModalTitle">‚ûï Nuovo Impianto</h3>
                <button onclick="closeRoomModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úñÔ∏è</button>
            </div>
            <div class="modal-body">
                <form id="roomForm">
                    <input type="hidden" id="roomId">
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üè∑Ô∏è Tag ID:</label>
                        <input type="text" id="roomTagId" placeholder="es. GE001, MT002, UPS003..." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" required>
                        <small style="color: #666;">Formato consigliato: PREFISSO + NUMERO (es. GE001)</small>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üìù Nome Impianto:</label>
                        <input type="text" id="roomName" placeholder="es. Gruppo Elettrogeno Principale" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" required>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üìÇ Categoria:</label>
                        <select id="roomCategory" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" required>
                            <option value="">Seleziona categoria...</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üìÑ Descrizione:</label>
                        <textarea id="roomDescription" placeholder="Descrizione dettagliata dell'impianto..." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; height: 80px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üìç Posizione GPS (opzionale):</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                            <input type="number" id="roomLat" placeholder="Latitudine" step="any" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="roomLng" placeholder="Longitudine" step="any" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="roomRadius" placeholder="Raggio (m)" min="10" max="500" value="50" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <small style="color: #666;">Lascia vuoto per disabilitare validazione GPS</small>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" onclick="closeRoomModal()" style="background: #666; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                            Annulla
                        </button>
                        <button type="submit" style="background: #4CAF50; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                            üíæ Salva Impianto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL AGGIUNGI CATEGORIA -->
    <div id="categoryModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>üìÇ Nuova Categoria</h3>
                <button onclick="closeCategoryModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úñÔ∏è</button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üìù Nome Categoria:</label>
                        <input type="text" id="categoryName" placeholder="es. Gruppi Elettrogeni" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" required>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üìÑ Descrizione:</label>
                        <textarea id="categoryDescription" placeholder="Descrizione della categoria..." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; height: 60px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" onclick="closeCategoryModal()" style="background: #666; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                            Annulla
                        </button>
                        <button type="submit" style="background: #2196F3; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                            üíæ Salva Categoria
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL AGGIUNGI OPERATORE -->
    <div id="operatorModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="operatorModalTitle">üë§ Nuovo Operatore</h3>
                <button onclick="closeOperatorModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úñÔ∏è</button>
            </div>
            <div class="modal-body">
                <form id="operatorForm">
                    <input type="hidden" id="operatorId">
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üë§ Nome Completo:</label>
                        <input type="text" id="operatorName" placeholder="es. Mario Rossi" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" required>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üè∑Ô∏è Codice Operatore:</label>
                        <input type="text" id="operatorCode" placeholder="es. MR001" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" required>
                        <small style="color: #666;">Formato consigliato: INIZIALI + NUMERO</small>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üÜî ID Operatore:</label>
                        <input type="text" id="operatorOperatorId" placeholder="es. OP001" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" required>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">‚úçÔ∏è Firma Digitale:</label>
                        <input type="text" id="operatorSignature" placeholder="es. Mario Rossi" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                        <small style="color: #666;">Testo che apparir√† come firma nei report</small>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" onclick="closeOperatorModal()" style="background: #666; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                            Annulla
                        </button>
                        <button type="submit" style="background: #FF9800; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                            üíæ Salva Operatore
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIGURAZIONE AZIENDA -->
    <div id="companyConfigModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>üè¢ Configurazione Azienda</h3>
                <button onclick="closeCompanyConfigModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úñÔ∏è</button>
            </div>
            <div class="modal-body">
                <form id="companyConfigForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üè¢ Nome Azienda:</label>
                            <input type="text" id="companyName" placeholder="es. LA TUA AZIENDA S.R.L." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" required>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üìß Email:</label>
                            <input type="email" id="companyEmail" placeholder="info@tuaazienda.it" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üìç Indirizzo:</label>
                            <input type="text" id="companyAddress" placeholder="Via Esempio 123, Roma" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üìû Telefono:</label>
                            <input type="tel" id="companyPhone" placeholder="+39 06 1234567" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üë®‚Äçüíº Responsabile Tecnico:</label>
                            <input type="text" id="technicalManager" placeholder="Ing. Mario Rossi" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üîß Resp. Manutenzione:</label>
                            <input type="text" id="maintenanceManager" placeholder="Geom. Luigi Bianchi" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">üñºÔ∏è Logo Aziendale:</label>
                        <input type="file" id="companyLogo" accept="image/*" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                        <small style="color: #666;">Formati supportati: PNG, JPG, SVG. Dimensione consigliata: 200x60px</small>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" onclick="closeCompanyConfigModal()" style="background: #666; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                            Annulla
                        </button>
                        <button type="submit" style="background: #8e44ad; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                            üíæ Salva Configurazione
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .room-config-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }
        
        .room-config-item:hover {
            background: #e9ecef;
        }
        
        .room-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .room-config-title {
            font-weight: bold;
            color: #333;
        }
        
        .room-config-tag {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: monospace;
        }
        
        .room-config-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-edit {
            background: #ffc107;
            color: #000;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .category-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* RESPONSIVE MOBILE */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .nav-tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding: 0 1rem;
            }
            
            .nav-tab {
                display: inline-block;
                min-width: 120px;
                text-align: center;
                font-size: 0.9rem;
                padding: 0.75rem 1rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .buttons {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
                padding: 1rem;
                font-size: 0.9rem;
            }
            
            .card {
                margin-bottom: 1rem;
            }
            
            .card-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .table {
                font-size: 0.8rem;
            }
            
            .table th,
            .table td {
                padding: 0.5rem 0.25rem;
            }
            
            .modal-content {
                width: 95%;
                max-width: none;
                margin: 1rem;
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            .register-content {
                padding: 20px;
                font-size: 12px;
            }
            
            .register-table {
                font-size: 10px;
            }
            
            .register-table th,
            .register-table td {
                padding: 6px 4px;
            }
            
            .signature-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .register-info {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.25rem;
            }
            
            .nav-tab {
                font-size: 0.8rem;
                padding: 0.5rem 0.75rem;
                min-width: 100px;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            .btn {
                padding: 0.875rem;
                font-size: 0.85rem;
            }
            
            .table {
                font-size: 0.75rem;
            }
            
            .register-title {
                font-size: 18px;
            }
            
            .register-subtitle {
                font-size: 14px;
            }
        }
    </style>

    <script>
        // Configurazione Supabase - INSERISCI LE TUE CREDENZIALI
        const SUPABASE_URL = 'https://pynodlnwozlyxcfwfqvp.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_C61rsZm3YWmvz82MHGkTAg_RGQQXCL6';
        
        // Inizializzazione
        let api;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Inizializza API client
            api = new ControlsAPI(SUPABASE_URL, SUPABASE_KEY);
            
            // Carica dati iniziali
            refreshData();
        });
        
        function showTab(tabName) {
            // Nascondi tutti i tab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostra tab selezionato
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Carica dati specifici del tab
            if (tabName === 'operators') loadOperators();
            if (tabName === 'rooms') loadRooms();
            if (tabName === 'unknown-tags') loadUnknownTags();
            if (tabName === 'config') loadConfigTab();
        }
        
        async function refreshData() {
            try {
                // Carica statistiche
                const stats = await api.getStats();
                
                document.getElementById('totalOperators').textContent = stats.totalOperators;
                document.getElementById('totalRooms').textContent = stats.totalRooms;
                document.getElementById('todayControls').textContent = stats.todayControls;
                document.getElementById('pendingTags').textContent = stats.pendingTags;
                
                // Carica controlli recenti
                await loadRecentControls();
                
            } catch (error) {
                console.error('Errore caricamento dati:', error);
                showError('Errore connessione database');
            }
        }
        
        async function loadRecentControls() {
            try {
                const controls = await api.getRecentControls(5);
                const container = document.getElementById('recentControls');
                
                if (controls.length === 0) {
                    container.innerHTML = '<p style="padding: 1.5rem; text-align: center; color: #64748b;">Nessun controllo registrato oggi</p>';
                    return;
                }
                
                container.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data/Ora</th>
                                <th>Operatore</th>
                                <th>Impianto</th>
                                <th>Tag</th>
                                <th>Stato</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${controls.map(control => `
                                <tr>
                                    <td>${new Date(control.timestamp).toLocaleString('it-IT')}</td>
                                    <td>${control.operators?.name || 'N/A'}</td>
                                    <td>${control.technical_rooms?.name || 'N/A'}</td>
                                    <td><code>${control.tag_id}</code></td>
                                    <td>
                                        <span class="status-badge ${control.location_valid ? 'status-approved' : 'status-pending'}">
                                            ${control.location_valid ? '‚úÖ Valido' : '‚ö†Ô∏è GPS Invalido'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
            } catch (error) {
                console.error('Errore caricamento controlli:', error);
                document.getElementById('recentControls').innerHTML = '<p style="padding: 1.5rem; color: #ef4444;">Errore caricamento controlli</p>';
            }
        }
        
        async function loadOperators() {
            try {
                const operators = await api.getOperators();
                const container = document.getElementById('operatorsList');
                
                container.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Codice</th>
                                <th>ID</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${operators.map(op => `
                                <tr>
                                    <td><strong>${op.name}</strong></td>
                                    <td><code>${op.code}</code></td>
                                    <td><code>${op.operator_id}</code></td>
                                    <td>
                                        <span class="status-badge status-approved">
                                            ‚úÖ Attivo
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editOperator('${op.id}')">‚úèÔ∏è Modifica</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
            } catch (error) {
                console.error('Errore caricamento operatori:', error);
                showError('Errore caricamento operatori');
            }
        }
        
        async function loadRooms() {
            try {
                const rooms = await api.getTechnicalRooms();
                const container = document.getElementById('roomsList');
                
                if (rooms.length === 0) {
                    container.innerHTML = '<p style="padding: 1.5rem; text-align: center; color: #64748b;">Nessun impianto configurato. Aggiungi il primo impianto!</p>';
                    return;
                }
                
                container.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Tag ID</th>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Descrizione</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rooms.map(room => `
                                <tr>
                                    <td><code>${room.tag_id}</code></td>
                                    <td><strong>${room.name}</strong></td>
                                    <td>${room.categories?.name || 'N/A'}</td>
                                    <td>${room.description || 'N/A'}</td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editRoom('${room.id}')">‚úèÔ∏è Modifica</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
            } catch (error) {
                console.error('Errore caricamento impianti:', error);
                showError('Errore caricamento impianti');
            }
        }
        
        async function loadUnknownTags() {
            try {
                const unknownTags = await api.getUnknownTags();
                const container = document.getElementById('unknownTagsList');
                
                if (unknownTags.length === 0) {
                    container.innerHTML = '<p style="padding: 1.5rem; text-align: center; color: #10b981;">‚úÖ Nessun tag sconosciuto in attesa di approvazione</p>';
                    return;
                }
                
                container.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Tag ID</th>
                                <th>Rilevato da</th>
                                <th>Data</th>
                                <th>Nome Suggerito</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${unknownTags.map(tag => `
                                <tr>
                                    <td><code>${tag.tag_id}</code></td>
                                    <td>${tag.operators?.name || 'N/A'}</td>
                                    <td>${new Date(tag.detected_at).toLocaleString('it-IT')}</td>
                                    <td>${tag.suggested_name}</td>
                                    <td>
                                        <button class="btn btn-success" onclick="quickApproveTag('${tag.tag_id}', '${tag.suggested_name}', '${tag.suggested_category}')">‚úÖ Approva</button>
                                        <button class="btn btn-primary" onclick="customApproveTag('${tag.tag_id}')">‚úèÔ∏è Personalizza</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
            } catch (error) {
                console.error('Errore caricamento tag sconosciuti:', error);
                showError('Errore caricamento tag sconosciuti');
            }
        }
        
        function showError(message) {
            // Implementazione notifica errore
            alert('‚ùå ' + message);
        }
        
        function showSuccess(message) {
            // Implementazione notifica successo
            alert('‚úÖ ' + message);
        }
        
        // ===== FUNZIONI REPORT E REGISTRI =====
        
        async function generateShiftRegister() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const operatorId = document.getElementById('reportOperator').value;
            const shift = document.getElementById('reportShift').value;
            
            if (!startDate || !endDate) {
                alert('Seleziona periodo per il report');
                return;
            }
            
            try {
                const filters = {
                    startDate: startDate + 'T00:00:00',
                    endDate: endDate + 'T23:59:59'
                };
                
                if (operatorId) filters.operatorId = operatorId;
                
                const controls = await api.getControls(filters);
                
                // Filtra per turno se specificato
                let filteredControls = controls;
                if (shift) {
                    filteredControls = controls.filter(control => {
                        const hour = new Date(control.timestamp).getHours();
                        switch(shift) {
                            case 'morning': return hour >= 6 && hour < 14;
                            case 'afternoon': return hour >= 14 && hour < 22;
                            case 'night': return hour >= 22 || hour < 6;
                            default: return true;
                        }
                    });
                }
                
                const html = generateShiftRegisterHTML(filteredControls, startDate, endDate, shift);
                showReportPreview(html);
                
            } catch (error) {
                console.error('Errore generazione registro turni:', error);
                showError('Errore generazione registro turni');
            }
        }
        
        async function generateElectricalRegister() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Seleziona periodo per il report');
                return;
            }
            
            try {
                const filters = {
                    startDate: startDate + 'T00:00:00',
                    endDate: endDate + 'T23:59:59'
                };
                
                const controls = await api.getControls(filters);
                
                // Filtra solo impianti elettrici
                const electricalControls = controls.filter(control => 
                    control.technical_rooms?.categories?.name?.includes('Elettr') ||
                    control.technical_rooms?.categories?.name?.includes('UPS') ||
                    control.technical_rooms?.categories?.name?.includes('Quadr') ||
                    control.technical_rooms?.categories?.name?.includes('Gener')
                );
                
                const html = generateElectricalRegisterHTML(electricalControls, startDate, endDate);
                showReportPreview(html);
                
            } catch (error) {
                console.error('Errore generazione registro elettrico:', error);
                showError('Errore generazione registro elettrico');
            }
        }
        
        async function generateSignedReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Seleziona periodo per il report');
                return;
            }
            
            try {
                const filters = {
                    startDate: startDate + 'T00:00:00',
                    endDate: endDate + 'T23:59:59'
                };
                
                const controls = await api.getControls(filters);
                const html = generateSignedReportHTML(controls, startDate, endDate);
                showReportPreview(html);
                
            } catch (error) {
                console.error('Errore generazione report firmato:', error);
                showError('Errore generazione report firmato');
            }
        }
        
        async function generateFullReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Seleziona periodo per il report');
                return;
            }
            
            try {
                const filters = {
                    startDate: startDate + 'T00:00:00',
                    endDate: endDate + 'T23:59:59'
                };
                
                const controls = await api.getControls(filters);
                const stats = await calculateReportStats(controls);
                const html = generateFullReportHTML(controls, stats, startDate, endDate);
                showReportPreview(html);
                
            } catch (error) {
                console.error('Errore generazione report completo:', error);
                showError('Errore generazione report completo');
            }
        }
        
        function generateShiftRegisterHTML(controls, startDate, endDate, shift) {
            const shiftName = {
                'morning': 'Mattino (06:00-14:00)',
                'afternoon': 'Pomeriggio (14:00-22:00)', 
                'night': 'Notte (22:00-06:00)',
                '': 'Tutti i turni'
            }[shift || ''];
            
            return `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #333; padding-bottom: 1rem;">
                        <h1 style="color: #333; margin: 0;">üìÖ REGISTRO CONTROLLI TURNI</h1>
                        <h2 style="color: #666; margin: 0.5rem 0;">${shiftName}</h2>
                        <p style="margin: 0.5rem 0;">Periodo: ${new Date(startDate).toLocaleDateString('it-IT')} - ${new Date(endDate).toLocaleDateString('it-IT')}</p>
                        <p style="margin: 0; font-size: 0.9rem; color: #888;">Generato il ${new Date().toLocaleString('it-IT')}</p>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 2rem;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left;">Data/Ora</th>
                                <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left;">Impianto</th>
                                <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left;">Operatore</th>
                                <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left;">Turno</th>
                                <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left;">GPS</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${controls.map(control => {
                                const date = new Date(control.timestamp);
                                const hour = date.getHours();
                                const shiftType = hour >= 6 && hour < 14 ? 'Mattino' : 
                                                hour >= 14 && hour < 22 ? 'Pomeriggio' : 'Notte';
                                const gpsStatus = control.location_valid ? '‚úÖ Valido' : '‚ö†Ô∏è Fuori zona';
                                
                                return `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 0.5rem;">${date.toLocaleString('it-IT')}</td>
                                        <td style="border: 1px solid #ddd; padding: 0.5rem;">${control.technical_rooms?.name || control.tag_id}</td>
                                        <td style="border: 1px solid #ddd; padding: 0.5rem;">${control.operators?.name || 'N/A'}</td>
                                        <td style="border: 1px solid #ddd; padding: 0.5rem;">${shiftType}</td>
                                        <td style="border: 1px solid #ddd; padding: 0.5rem;">${gpsStatus}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 2rem; padding: 1rem; background: #f9f9f9; border-radius: 8px;">
                        <h3>üìä Riepilogo</h3>
                        <p><strong>Totale controlli:</strong> ${controls.length}</p>
                        <p><strong>Controlli validi GPS:</strong> ${controls.filter(c => c.location_valid).length}</p>
                        <p><strong>Operatori coinvolti:</strong> ${new Set(controls.map(c => c.operators?.name)).size}</p>
                        <p><strong>Impianti controllati:</strong> ${new Set(controls.map(c => c.technical_rooms?.name)).size}</p>
                    </div>
                    
                    <div style="margin-top: 2rem; text-align: center; font-size: 0.8rem; color: #666;">
                        <p>Sistema Controlli Industriali - Report generato automaticamente</p>
                    </div>
                </div>
            `;
        }
        
        function generateElectricalRegisterHTML(controls, startDate, endDate) {
            return `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #FF9800; padding-bottom: 1rem;">
                        <h1 style="color: #FF9800; margin: 0;">‚ö° REGISTRO IMPIANTI ELETTRICI</h1>
                        <p style="margin: 0.5rem 0;">Periodo: ${new Date(startDate).toLocaleDateString('it-IT')} - ${new Date(endDate).toLocaleDateString('it-IT')}</p>
                        <p style="margin: 0; font-size: 0.9rem; color: #888;">Generato il ${new Date().toLocaleString('it-IT')}</p>
                    </div>
                    
                    <div style="margin-bottom: 2rem; padding: 1rem; background: #fff3e0; border-left: 4px solid #FF9800;">
                        <h3 style="color: #FF9800; margin-top: 0;">‚ö†Ô∏è Controlli Impianti Elettrici</h3>
                        <p>Questo registro documenta tutti i controlli effettuati su impianti elettrici, gruppi elettrogeni, UPS e quadri elettrici.</p>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 2rem;">
                        <thead>
                            <tr style="background: #fff3e0;">
                                <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left;">Data/Ora</th>
                                <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left;">Impianto</th>
                                <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left;">Categoria</th>
                                <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left;">Operatore</th>
                                <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left;">Stato</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${controls.map(control => {
                                const date = new Date(control.timestamp);
                                const status = control.location_valid ? '‚úÖ OK' : '‚ö†Ô∏è Anomalia GPS';
                                
                                return `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 0.5rem;">${date.toLocaleString('it-IT')}</td>
                                        <td style="border: 1px solid #ddd; padding: 0.5rem;"><strong>${control.technical_rooms?.name || control.tag_id}</strong></td>
                                        <td style="border: 1px solid #ddd; padding: 0.5rem;">${control.technical_rooms?.categories?.name || 'N/A'}</td>
                                        <td style="border: 1px solid #ddd; padding: 0.5rem;">${control.operators?.name || 'N/A'}</td>
                                        <td style="border: 1px solid #ddd; padding: 0.5rem;">${status}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 2rem; padding: 1rem; background: #f9f9f9; border-radius: 8px;">
                        <h3>üìä Riepilogo Impianti Elettrici</h3>
                        <p><strong>Totale controlli elettrici:</strong> ${controls.length}</p>
                        <p><strong>Controlli conformi:</strong> ${controls.filter(c => c.location_valid).length}</p>
                        <p><strong>Anomalie rilevate:</strong> ${controls.filter(c => !c.location_valid).length}</p>
                    </div>
                </div>
            `;
        }
        
        function generateSignedReportHTML(controls, startDate, endDate) {
            // Raggruppa per operatore
            const byOperator = {};
            controls.forEach(control => {
                const operatorName = control.operators?.name || 'N/A';
                if (!byOperator[operatorName]) {
                    byOperator[operatorName] = [];
                }
                byOperator[operatorName].push(control);
            });
            
            return `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #4CAF50; padding-bottom: 1rem;">
                        <h1 style="color: #4CAF50; margin: 0;">üñäÔ∏è REPORT CON FIRME DIGITALI</h1>
                        <p style="margin: 0.5rem 0;">Periodo: ${new Date(startDate).toLocaleDateString('it-IT')} - ${new Date(endDate).toLocaleDateString('it-IT')}</p>
                        <p style="margin: 0; font-size: 0.9rem; color: #888;">Generato il ${new Date().toLocaleString('it-IT')}</p>
                    </div>
                    
                    ${Object.entries(byOperator).map(([operatorName, operatorControls]) => `
                        <div style="margin-bottom: 3rem; page-break-inside: avoid;">
                            <div style="background: #e8f5e8; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h3 style="margin: 0; color: #2e7d32;">üë§ ${operatorName}</h3>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">Controlli effettuati: ${operatorControls.length}</p>
                            </div>
                            
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="border: 1px solid #ddd; padding: 0.5rem; text-align: left;">Data/Ora</th>
                                        <th style="border: 1px solid #ddd; padding: 0.5rem; text-align: left;">Impianto</th>
                                        <th style="border: 1px solid #ddd; padding: 0.5rem; text-align: left;">Validazione</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${operatorControls.map(control => `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 0.5rem;">${new Date(control.timestamp).toLocaleString('it-IT')}</td>
                                            <td style="border: 1px solid #ddd; padding: 0.5rem;">${control.technical_rooms?.name || control.tag_id}</td>
                                            <td style="border: 1px solid #ddd; padding: 0.5rem;">${control.location_valid ? '‚úÖ Validato' : '‚ö†Ô∏è Da verificare'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            
                            <div style="margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; background: #fafafa;">
                                <p style="margin: 0 0 1rem 0;"><strong>Dichiarazione:</strong></p>
                                <p style="margin: 0 0 1rem 0; font-size: 0.9rem;">
                                    Il sottoscritto <strong>${operatorName}</strong> dichiara di aver effettuato tutti i controlli sopra elencati 
                                    presso gli impianti indicati, nelle date e orari specificati, con validazione GPS automatica.
                                </p>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem;">
                                    <div>
                                        <p style="margin: 0; font-size: 0.9rem;">Data: ${new Date().toLocaleDateString('it-IT')}</p>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="border-bottom: 1px solid #333; width: 200px; margin-bottom: 0.5rem;"></div>
                                        <p style="margin: 0; font-size: 0.8rem;">Firma ${operatorName}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    
                    <div style="margin-top: 2rem; text-align: center; font-size: 0.8rem; color: #666; border-top: 1px solid #ddd; padding-top: 1rem;">
                        <p>Sistema Controlli Industriali - Report con validazione digitale</p>
                        <p>Tutti i controlli sono tracciati con NFC e GPS per garantire l'autenticit√†</p>
                    </div>
                </div>
            `;
        }
        
        function generateFullReportHTML(controls, stats, startDate, endDate) {
            return `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #9C27B0; padding-bottom: 1rem;">
                        <h1 style="color: #9C27B0; margin: 0;">üìä REPORT COMPLETO CONTROLLI</h1>
                        <p style="margin: 0.5rem 0;">Periodo: ${new Date(startDate).toLocaleDateString('it-IT')} - ${new Date(endDate).toLocaleDateString('it-IT')}</p>
                        <p style="margin: 0; font-size: 0.9rem; color: #888;">Generato il ${new Date().toLocaleString('it-IT')}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #1976d2;">${controls.length}</div>
                            <div style="font-size: 0.9rem; color: #666;">Controlli Totali</div>
                        </div>
                        <div style="background: #e8f5e8; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #388e3c;">${stats.validControls}</div>
                            <div style="font-size: 0.9rem; color: #666;">Controlli Validi</div>
                        </div>
                        <div style="background: #fff3e0; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #f57c00;">${stats.uniqueOperators}</div>
                            <div style="font-size: 0.9rem; color: #666;">Operatori</div>
                        </div>
                        <div style="background: #fce4ec; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #c2185b;">${stats.uniqueRooms}</div>
                            <div style="font-size: 0.9rem; color: #666;">Impianti</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h3>üìà Distribuzione per Turno</h3>
                        <div style="background: #f9f9f9; padding: 1rem; border-radius: 8px;">
                            <p><strong>Mattino (06-14):</strong> ${stats.shiftDistribution.morning} controlli</p>
                            <p><strong>Pomeriggio (14-22):</strong> ${stats.shiftDistribution.afternoon} controlli</p>
                            <p><strong>Notte (22-06):</strong> ${stats.shiftDistribution.night} controlli</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h3>üèÜ Top Performers</h3>
                        <div style="background: #f9f9f9; padding: 1rem; border-radius: 8px;">
                            <p><strong>Operatore pi√π attivo:</strong> ${stats.topOperator.name} (${stats.topOperator.count} controlli)</p>
                            <p><strong>Impianto pi√π controllato:</strong> ${stats.topRoom.name} (${stats.topRoom.count} controlli)</p>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 2rem;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left;">Data/Ora</th>
                                <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left;">Impianto</th>
                                <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left;">Operatore</th>
                                <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left;">Stato</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${controls.slice(0, 50).map(control => `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 0.5rem;">${new Date(control.timestamp).toLocaleString('it-IT')}</td>
                                    <td style="border: 1px solid #ddd; padding: 0.5rem;">${control.technical_rooms?.name || control.tag_id}</td>
                                    <td style="border: 1px solid #ddd; padding: 0.5rem;">${control.operators?.name || 'N/A'}</td>
                                    <td style="border: 1px solid #ddd; padding: 0.5rem;">${control.location_valid ? '‚úÖ OK' : '‚ö†Ô∏è Anomalia'}</td>
                                </tr>
                            `).join('')}
                            ${controls.length > 50 ? `<tr><td colspan="4" style="text-align: center; padding: 1rem; font-style: italic;">... e altri ${controls.length - 50} controlli</td></tr>` : ''}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        async function calculateReportStats(controls) {
            const validControls = controls.filter(c => c.location_valid).length;
            const uniqueOperators = new Set(controls.map(c => c.operators?.name)).size;
            const uniqueRooms = new Set(controls.map(c => c.technical_rooms?.name)).size;
            
            // Distribuzione turni
            const shiftDistribution = {
                morning: 0,
                afternoon: 0,
                night: 0
            };
            
            controls.forEach(control => {
                const hour = new Date(control.timestamp).getHours();
                if (hour >= 6 && hour < 14) shiftDistribution.morning++;
                else if (hour >= 14 && hour < 22) shiftDistribution.afternoon++;
                else shiftDistribution.night++;
            });
            
            // Top operatore
            const operatorCounts = {};
            controls.forEach(control => {
                const name = control.operators?.name || 'N/A';
                operatorCounts[name] = (operatorCounts[name] || 0) + 1;
            });
            const topOperator = Object.entries(operatorCounts).reduce((a, b) => 
                operatorCounts[a[0]] > operatorCounts[b[0]] ? a : b, ['N/A', 0]);
            
            // Top impianto
            const roomCounts = {};
            controls.forEach(control => {
                const name = control.technical_rooms?.name || control.tag_id;
                roomCounts[name] = (roomCounts[name] || 0) + 1;
            });
            const topRoom = Object.entries(roomCounts).reduce((a, b) => 
                roomCounts[a[0]] > roomCounts[b[0]] ? a : b, ['N/A', 0]);
            
            return {
                validControls,
                uniqueOperators,
                uniqueRooms,
                shiftDistribution,
                topOperator: { name: topOperator[0], count: topOperator[1] },
                topRoom: { name: topRoom[0], count: topRoom[1] }
            };
        }
        
        async function loadAdvancedStats() {
            try {
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                
                const monthlyControls = await api.getControls({
                    startDate: startOfMonth.toISOString(),
                    endDate: now.toISOString()
                });
                
                const stats = await calculateReportStats(monthlyControls);
                
                document.getElementById('totalControlsMonth').textContent = monthlyControls.length;
                document.getElementById('avgControlsDay').textContent = Math.round(monthlyControls.length / now.getDate());
                document.getElementById('mostActiveOperator').textContent = stats.topOperator.name;
                document.getElementById('mostControlledRoom').textContent = stats.topRoom.name;
                
            } catch (error) {
                console.error('Errore caricamento statistiche avanzate:', error);
            }
        }
        
        function showReportPreview(html) {
            document.getElementById('reportContent').innerHTML = html;
            document.getElementById('reportPreview').style.display = 'block';
            document.getElementById('reportPreview').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closeReportPreview() {
            document.getElementById('reportPreview').style.display = 'none';
        }
        
        function printReport() {
            const content = document.getElementById('reportContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Report Controlli Industriali</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        ${content}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Inizializza date di default per i report
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('reportStartDate').value = weekAgo.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
            
            // Carica operatori nel select
            loadOperatorsForReport();
        });
        
        async function loadOperatorsForReport() {
            try {
                const operators = await api.getOperators();
                const select = document.getElementById('reportOperator');
                
                operators.forEach(operator => {
                    const option = document.createElement('option');
                    option.value = operator.id;
                    option.textContent = operator.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Errore caricamento operatori per report:', error);
            }
        }
        
        // ===== FUNZIONI CONFIGURAZIONE =====
        
        async function loadConfigTab() {
            await Promise.all([
                loadRoomsConfig(),
                loadCategoriesConfig(),
                loadOperatorsConfig()
            ]);
        }
        
        // === GESTIONE IMPIANTI ===
        
        async function loadRoomsConfig() {
            try {
                const rooms = await api.getTechnicalRooms();
                const container = document.getElementById('roomsConfigList');
                
                if (rooms.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Nessun impianto configurato</p>';
                    return;
                }
                
                container.innerHTML = rooms.map(room => `
                    <div class="room-config-item" data-tag="${room.tag_id.toLowerCase()}">
                        <div class="room-config-header">
                            <div>
                                <span class="room-config-title">${room.name}</span>
                                <span class="room-config-tag">${room.tag_id}</span>
                            </div>
                            <div class="room-config-actions">
                                <button class="btn-sm btn-edit" onclick="editRoom('${room.id}')">‚úèÔ∏è Modifica</button>
                                <button class="btn-sm btn-delete" onclick="deleteRoom('${room.id}', '${room.name}')">üóëÔ∏è Elimina</button>
                            </div>
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">
                            <div><strong>Categoria:</strong> ${room.categories?.name || 'N/A'}</div>
                            ${room.description ? `<div><strong>Descrizione:</strong> ${room.description}</div>` : ''}
                            ${room.expected_lat ? `<div><strong>GPS:</strong> ${room.expected_lat}, ${room.expected_lng} (¬±${room.gps_radius}m)</div>` : '<div><strong>GPS:</strong> Non configurato</div>'}
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Errore caricamento impianti config:', error);
                document.getElementById('roomsConfigList').innerHTML = '<p style="color: #dc3545; text-align: center; padding: 2rem;">Errore caricamento impianti</p>';
            }
        }
        
        function filterRooms() {
            const search = document.getElementById('searchRooms').value.toLowerCase();
            const items = document.querySelectorAll('.room-config-item');
            
            items.forEach(item => {
                const tag = item.dataset.tag;
                const text = item.textContent.toLowerCase();
                const visible = tag.includes(search) || text.includes(search);
                item.style.display = visible ? 'block' : 'none';
            });
        }
        
        async function showAddRoomModal() {
            document.getElementById('roomModalTitle').textContent = '‚ûï Nuovo Impianto';
            document.getElementById('roomForm').reset();
            document.getElementById('roomId').value = '';
            
            // Carica categorie nel select
            await loadCategoriesInSelect();
            
            document.getElementById('roomModal').style.display = 'flex';
        }
        
        async function editRoom(roomId) {
            try {
                const rooms = await api.getTechnicalRooms();
                const room = rooms.find(r => r.id === roomId);
                
                if (!room) {
                    showError('Impianto non trovato');
                    return;
                }
                
                document.getElementById('roomModalTitle').textContent = '‚úèÔ∏è Modifica Impianto';
                document.getElementById('roomId').value = room.id;
                document.getElementById('roomTagId').value = room.tag_id;
                document.getElementById('roomName').value = room.name;
                document.getElementById('roomDescription').value = room.description || '';
                document.getElementById('roomLat').value = room.expected_lat || '';
                document.getElementById('roomLng').value = room.expected_lng || '';
                document.getElementById('roomRadius').value = room.gps_radius || 50;
                
                await loadCategoriesInSelect();
                document.getElementById('roomCategory').value = room.category_id || '';
                
                document.getElementById('roomModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Errore caricamento impianto:', error);
                showError('Errore caricamento dati impianto');
            }
        }
        
        async function deleteRoom(roomId, roomName) {
            if (!confirm(`Sei sicuro di voler eliminare l'impianto "${roomName}"?\n\nQuesta azione non pu√≤ essere annullata.`)) {
                return;
            }
            
            try {
                // Nota: Supabase non ha un metodo delete diretto nell'API client
                // Dovremmo implementarlo o usare una chiamata diretta
                const response = await fetch(`${api.supabaseUrl}/rest/v1/technical_rooms?id=eq.${roomId}`, {
                    method: 'DELETE',
                    headers: api.headers
                });
                
                if (!response.ok) {
                    throw new Error('Errore eliminazione impianto');
                }
                
                showSuccess(`Impianto "${roomName}" eliminato con successo`);
                await loadRoomsConfig();
                
            } catch (error) {
                console.error('Errore eliminazione impianto:', error);
                showError('Errore eliminazione impianto');
            }
        }
        
        function closeRoomModal() {
            document.getElementById('roomModal').style.display = 'none';
        }
        
        // === GESTIONE CATEGORIE ===
        
        async function loadCategoriesConfig() {
            try {
                const categories = await api.getCategories();
                const container = document.getElementById('categoriesList');
                
                if (categories.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 1rem;">Nessuna categoria configurata</p>';
                    return;
                }
                
                container.innerHTML = categories.map(category => `
                    <div class="category-item">
                        <div>
                            <strong>${category.name}</strong>
                            ${category.description ? `<br><small style="color: #666;">${category.description}</small>` : ''}
                        </div>
                        <div>
                            <button class="btn-sm btn-delete" onclick="deleteCategory('${category.id}', '${category.name}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Errore caricamento categorie:', error);
                document.getElementById('categoriesList').innerHTML = '<p style="color: #dc3545; text-align: center; padding: 1rem;">Errore caricamento categorie</p>';
            }
        }
        
        async function loadCategoriesInSelect() {
            try {
                const categories = await api.getCategories();
                const select = document.getElementById('roomCategory');
                
                // Mantieni l'opzione vuota
                select.innerHTML = '<option value="">Seleziona categoria...</option>';
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Errore caricamento categorie per select:', error);
            }
        }
        
        function showAddCategoryModal() {
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryModal').style.display = 'flex';
        }
        
        async function deleteCategory(categoryId, categoryName) {
            if (!confirm(`Sei sicuro di voler eliminare la categoria "${categoryName}"?\n\nGli impianti associati rimarranno senza categoria.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${api.supabaseUrl}/rest/v1/categories?id=eq.${categoryId}`, {
                    method: 'DELETE',
                    headers: api.headers
                });
                
                if (!response.ok) {
                    throw new Error('Errore eliminazione categoria');
                }
                
                showSuccess(`Categoria "${categoryName}" eliminata con successo`);
                await loadCategoriesConfig();
                
            } catch (error) {
                console.error('Errore eliminazione categoria:', error);
                showError('Errore eliminazione categoria');
            }
        }
        
        function closeCategoryModal() {
            document.getElementById('categoryModal').style.display = 'none';
        }
        
        // === GESTIONE OPERATORI ===
        
        async function loadOperatorsConfig() {
            try {
                const operators = await api.getOperators();
                const container = document.getElementById('operatorsConfigList');
                
                if (operators.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Nessun operatore configurato</p>';
                    return;
                }
                
                container.innerHTML = operators.map(operator => `
                    <div class="operator-config-item">
                        <div>
                            <div style="font-weight: bold;">${operator.name}</div>
                            <div style="font-size: 0.9rem; color: #666;">
                                Codice: ${operator.code} | ID: ${operator.operator_id}
                                ${operator.digital_signature ? ` | Firma: ${operator.digital_signature}` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-sm btn-edit" onclick="editOperator('${operator.id}')">‚úèÔ∏è Modifica</button>
                            <button class="btn-sm btn-delete" onclick="deleteOperator('${operator.id}', '${operator.name}')">üóëÔ∏è Elimina</button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Errore caricamento operatori config:', error);
                document.getElementById('operatorsConfigList').innerHTML = '<p style="color: #dc3545; text-align: center; padding: 2rem;">Errore caricamento operatori</p>';
            }
        }
        
        function showAddOperatorModal() {
            document.getElementById('operatorModalTitle').textContent = 'üë§ Nuovo Operatore';
            document.getElementById('operatorForm').reset();
            document.getElementById('operatorId').value = '';
            document.getElementById('operatorModal').style.display = 'flex';
        }
        
        async function editOperator(operatorId) {
            try {
                const operators = await api.getOperators();
                const operator = operators.find(o => o.id === operatorId);
                
                if (!operator) {
                    showError('Operatore non trovato');
                    return;
                }
                
                document.getElementById('operatorModalTitle').textContent = '‚úèÔ∏è Modifica Operatore';
                document.getElementById('operatorId').value = operator.id;
                document.getElementById('operatorName').value = operator.name;
                document.getElementById('operatorCode').value = operator.code;
                document.getElementById('operatorOperatorId').value = operator.operator_id;
                document.getElementById('operatorSignature').value = operator.digital_signature || '';
                
                document.getElementById('operatorModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Errore caricamento operatore:', error);
                showError('Errore caricamento dati operatore');
            }
        }
        
        async function deleteOperator(operatorId, operatorName) {
            if (!confirm(`Sei sicuro di voler eliminare l'operatore "${operatorName}"?\n\nI controlli esistenti rimarranno associati a questo operatore.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${api.supabaseUrl}/rest/v1/operators?id=eq.${operatorId}`, {
                    method: 'DELETE',
                    headers: api.headers
                });
                
                if (!response.ok) {
                    throw new Error('Errore eliminazione operatore');
                }
                
                showSuccess(`Operatore "${operatorName}" eliminato con successo`);
                await loadOperatorsConfig();
                
            } catch (error) {
                console.error('Errore eliminazione operatore:', error);
                showError('Errore eliminazione operatore');
            }
        }
        
        function closeOperatorModal() {
            document.getElementById('operatorModal').style.display = 'none';
        }
        
        // === FORM HANDLERS ===
        
        document.getElementById('roomForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const roomData = {
                tag_id: document.getElementById('roomTagId').value.trim().toUpperCase(),
                name: document.getElementById('roomName').value.trim(),
                description: document.getElementById('roomDescription').value.trim() || null,
                category_id: document.getElementById('roomCategory').value || null,
                expected_lat: parseFloat(document.getElementById('roomLat').value) || null,
                expected_lng: parseFloat(document.getElementById('roomLng').value) || null,
                gps_radius: parseInt(document.getElementById('roomRadius').value) || 50,
                active: true
            };
            
            try {
                const roomId = document.getElementById('roomId').value;
                
                if (roomId) {
                    // Modifica esistente
                    const response = await fetch(`${api.supabaseUrl}/rest/v1/technical_rooms?id=eq.${roomId}`, {
                        method: 'PATCH',
                        headers: api.headers,
                        body: JSON.stringify(roomData)
                    });
                    
                    if (!response.ok) {
                        throw new Error('Errore aggiornamento impianto');
                    }
                    
                    showSuccess('Impianto aggiornato con successo');
                } else {
                    // Nuovo impianto
                    await api.addTechnicalRoom(roomData);
                    showSuccess('Impianto creato con successo');
                }
                
                closeRoomModal();
                await loadRoomsConfig();
                
            } catch (error) {
                console.error('Errore salvataggio impianto:', error);
                showError('Errore salvataggio impianto: ' + error.message);
            }
        });
        
        document.getElementById('categoryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const categoryData = {
                name: document.getElementById('categoryName').value.trim(),
                description: document.getElementById('categoryDescription').value.trim() || null
            };
            
            try {
                const response = await fetch(`${api.supabaseUrl}/rest/v1/categories`, {
                    method: 'POST',
                    headers: { ...api.headers, 'Prefer': 'return=representation' },
                    body: JSON.stringify(categoryData)
                });
                
                if (!response.ok) {
                    throw new Error('Errore creazione categoria');
                }
                
                showSuccess('Categoria creata con successo');
                closeCategoryModal();
                await loadCategoriesConfig();
                
            } catch (error) {
                console.error('Errore salvataggio categoria:', error);
                showError('Errore salvataggio categoria: ' + error.message);
            }
        });
        
        document.getElementById('operatorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const operatorData = {
                name: document.getElementById('operatorName').value.trim(),
                code: document.getElementById('operatorCode').value.trim().toUpperCase(),
                operator_id: document.getElementById('operatorOperatorId').value.trim().toUpperCase(),
                digital_signature: document.getElementById('operatorSignature').value.trim() || null,
                active: true
            };
            
            try {
                const operatorId = document.getElementById('operatorId').value;
                
                if (operatorId) {
                    // Modifica esistente
                    const response = await fetch(`${api.supabaseUrl}/rest/v1/operators?id=eq.${operatorId}`, {
                        method: 'PATCH',
                        headers: api.headers,
                        body: JSON.stringify(operatorData)
                    });
                    
                    if (!response.ok) {
                        throw new Error('Errore aggiornamento operatore');
                    }
                    
                    showSuccess('Operatore aggiornato con successo');
                } else {
                    // Nuovo operatore
                    await api.addOperator(operatorData);
                    showSuccess('Operatore creato con successo');
                }
                
                closeOperatorModal();
                await loadOperatorsConfig();
                
            } catch (error) {
                console.error('Errore salvataggio operatore:', error);
                showError('Errore salvataggio operatore: ' + error.message);
            }
        });
        
        // Chiudi modal cliccando fuori
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
        
        // Funzioni placeholder per azioni - RIMOSSE, ora implementate nel tab Configurazione
        
        async function quickApproveTag(tagId, suggestedName, suggestedCategory) {
            try {
                // Trova categoria ID
                const categories = await api.getCategories();
                const category = categories.find(c => c.name === suggestedCategory);
                
                await api.approveUnknownTag(tagId, {
                    name: suggestedName,
                    description: `Impianto ${tagId} - Configurato automaticamente`,
                    category_id: category?.id
                });
                
                showSuccess(`Tag ${tagId} approvato e configurato!`);
                loadUnknownTags(); // Ricarica lista
                refreshData(); // Aggiorna statistiche
                
            } catch (error) {
                console.error('Errore approvazione tag:', error);
                showError('Errore durante l\'approvazione del tag');
            }
        }
        
        function customApproveTag(tagId) {
            alert('Personalizzazione tag: ' + tagId + '\n(Usa il tab Configurazione per gestire i tag in modo completo)');
        }
        
        // Funzione per aprire i registri professionali
        function openProfessionalRegisters() {
            const url = 'registri-professionali.html';
            const windowFeatures = 'width=1400,height=900,scrollbars=yes,resizable=yes,toolbar=no,menubar=no';
            
            const newWindow = window.open(url, 'RegistriProfessionali', windowFeatures);
            
            if (newWindow) {
                newWindow.focus();
            } else {
                // Fallback se il popup √® bloccato
                alert('‚ö†Ô∏è Popup bloccato!\n\nPer aprire i registri professionali:\n1. Consenti popup per questo sito\n2. Oppure apri manualmente: ' + url);
            }
        }

        // ===== REGISTRI PROFESSIONALI INTEGRATI =====
        
        async function generateProfessionalElectricalRegister() {
            try {
                console.log('üîß Generazione registro elettrico...');
                const controls = await getFilteredControlsForProfessional();
                console.log('Controlli caricati:', controls.length);
                
                const electricalControls = controls.filter(control => 
                    isProfessionalElectricalPlant(control.technical_rooms?.categories?.name || control.tag_id)
                );
                console.log('Controlli elettrici filtrati:', electricalControls.length);
                
                const html = generateProfessionalRegisterHTML({
                    title: "REGISTRO CONTROLLI IMPIANTI ELETTRICI",
                    subtitle: "Controlli periodici impianti elettrici, gruppi elettrogeni, UPS e quadri elettrici",
                    icon: "‚ö°",
                    color: "#f39c12",
                    controls: electricalControls,
                    category: "elettrico"
                });
                
                showReportPreview(html);
                console.log('‚úÖ Registro elettrico generato');
            } catch (error) {
                console.error('‚ùå Errore generazione registro elettrico:', error);
                showError('Errore generazione registro elettrico: ' + error.message);
            }
        }
        
        async function generateProfessionalFireRegister() {
            const controls = await getFilteredControlsForProfessional();
            const fireControls = controls.filter(control => 
                isProfessionalFirePlant(control.technical_rooms?.categories?.name || control.tag_id)
            );
            
            const html = generateProfessionalRegisterHTML({
                title: "REGISTRO CONTROLLI ANTINCENDIO",
                subtitle: "Controlli periodici impianti antincendio e sistemi di sicurezza",
                icon: "üî•",
                color: "#e74c3c",
                controls: fireControls,
                category: "antincendio"
            });
            
            showReportPreview(html);
        }
        
        async function generateProfessionalHVACRegister() {
            const controls = await getFilteredControlsForProfessional();
            const hvacControls = controls.filter(control => 
                isProfessionalHVACPlant(control.technical_rooms?.categories?.name || control.tag_id)
            );
            
            const html = generateProfessionalRegisterHTML({
                title: "REGISTRO CONTROLLI HVAC",
                subtitle: "Controlli periodici sistemi di climatizzazione e ventilazione",
                icon: "‚ùÑÔ∏è",
                color: "#3498db",
                controls: hvacControls,
                category: "hvac"
            });
            
            showReportPreview(html);
        }
        
        async function generateProfessionalUPSRegister() {
            const controls = await getFilteredControlsForProfessional();
            const upsControls = controls.filter(control => 
                isProfessionalUPSPlant(control.technical_rooms?.categories?.name || control.tag_id)
            );
            
            const html = generateProfessionalRegisterHTML({
                title: "REGISTRO CONTROLLI UPS",
                subtitle: "Controlli periodici gruppi di continuit√† e alimentazioni ausiliarie",
                icon: "üîã",
                color: "#27ae60",
                controls: upsControls,
                category: "ups"
            });
            
            showReportPreview(html);
        }
        
        async function generateProfessionalCompleteRegister() {
            const controls = await getFilteredControlsForProfessional();
            
            const html = generateProfessionalRegisterHTML({
                title: "REGISTRO CONTROLLI COMPLETO",
                subtitle: "Controlli periodici di tutti gli impianti tecnici industriali",
                icon: "üìä",
                color: "#9b59b6",
                controls: controls,
                category: "completo"
            });
            
            showReportPreview(html);
        }
        
        async function generateProfessionalShiftRegister() {
            const controls = await getFilteredControlsForProfessional();
            
            const html = generateProfessionalRegisterHTML({
                title: "REGISTRO CONTROLLI PER TURNI",
                subtitle: "Controlli suddivisi per turni di lavoro (Mattino, Pomeriggio, Notte)",
                icon: "üïê",
                color: "#34495e",
                controls: controls,
                category: "turni",
                showShifts: true
            });
            
            showReportPreview(html);
        }
        
        async function getFilteredControlsForProfessional() {
            try {
                console.log('üìä Caricamento controlli filtrati...');
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                const operatorId = document.getElementById('reportOperator').value;
                const category = document.getElementById('reportCategory').value;
                
                console.log('Filtri:', { startDate, endDate, operatorId, category });
                
                if (!startDate || !endDate) {
                    alert('‚ö†Ô∏è Seleziona il periodo per il registro');
                    return [];
                }
                
                const filters = {
                    startDate: startDate + 'T00:00:00',
                    endDate: endDate + 'T23:59:59'
                };
                
                if (operatorId) filters.operatorId = operatorId;
                
                console.log('Chiamata API con filtri:', filters);
                let controls = await api.getControls(filters);
                console.log('Controlli ricevuti dall\'API:', controls.length);
                
                // Filtra per categoria se specificata
                if (category) {
                    const originalLength = controls.length;
                    controls = controls.filter(control => {
                        const plantName = control.technical_rooms?.categories?.name || control.tag_id;
                        switch(category) {
                            case 'elettrico': return isProfessionalElectricalPlant(plantName);
                            case 'antincendio': return isProfessionalFirePlant(plantName);
                            case 'hvac': return isProfessionalHVACPlant(plantName);
                            case 'ups': return isProfessionalUPSPlant(plantName);
                            default: return true;
                        }
                    });
                    console.log(`Filtro categoria ${category}: ${originalLength} ‚Üí ${controls.length} controlli`);
                }
                
                return controls;
            } catch (error) {
                console.error('‚ùå Errore caricamento controlli:', error);
                alert('‚ùå Errore caricamento dati: ' + error.message);
                return [];
            }
        }
        
        // ===== CONFIGURAZIONE AZIENDA =====
        
        function generateControlsTable(controls) {
            return `
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 12px;">
                    <thead>
                        <tr>
                            <th style="background: #34495e; color: white; padding: 12px 8px; text-align: left; font-weight: bold; border: 1px solid #2c3e50; width: 12%;">Data/Ora</th>
                            <th style="background: #34495e; color: white; padding: 12px 8px; text-align: left; font-weight: bold; border: 1px solid #2c3e50; width: 25%;">Impianto</th>
                            <th style="background: #34495e; color: white; padding: 12px 8px; text-align: left; font-weight: bold; border: 1px solid #2c3e50; width: 15%;">Tag ID</th>
                            <th style="background: #34495e; color: white; padding: 12px 8px; text-align: left; font-weight: bold; border: 1px solid #2c3e50; width: 20%;">Operatore</th>
                            <th style="background: #34495e; color: white; padding: 12px 8px; text-align: left; font-weight: bold; border: 1px solid #2c3e50; width: 10%;">Turno</th>
                            <th style="background: #34495e; color: white; padding: 12px 8px; text-align: left; font-weight: bold; border: 1px solid #2c3e50; width: 10%;">GPS</th>
                            <th style="background: #34495e; color: white; padding: 12px 8px; text-align: left; font-weight: bold; border: 1px solid #2c3e50; width: 8%;">Stato</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${controls.map((control, index) => {
                            const date = new Date(control.timestamp);
                            const hour = date.getHours();
                            const shift = hour >= 6 && hour < 14 ? 'Mattino' : 
                                        hour >= 14 && hour < 22 ? 'Pomeriggio' : 'Notte';
                            const gpsStatus = control.location_valid ? 'Valido' : 'Anomalia';
                            const statusColor = control.location_valid ? '#27ae60' : '#f39c12';
                            const rowColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                            const categoryColor = getProfessionalCategoryColor(control.technical_rooms?.categories?.name || control.tag_id);
                            
                            return `
                                <tr style="background: ${rowColor};">
                                    <td style="padding: 10px 8px; border: 1px solid #bdc3c7; vertical-align: top;">${date.toLocaleString('it-IT', { 
                                        day: '2-digit', 
                                        month: '2-digit', 
                                        year: '2-digit',
                                        hour: '2-digit', 
                                        minute: '2-digit' 
                                    })}</td>
                                    <td style="padding: 10px 8px; border: 1px solid #bdc3c7; vertical-align: top; background: ${categoryColor};"><strong>${control.technical_rooms?.name || 'Impianto ' + control.tag_id}</strong></td>
                                    <td style="padding: 10px 8px; border: 1px solid #bdc3c7; vertical-align: top;"><code style="background: #ecf0f1; padding: 2px 4px; border-radius: 3px;">${control.tag_id}</code></td>
                                    <td style="padding: 10px 8px; border: 1px solid #bdc3c7; vertical-align: top;">${control.operators?.name || 'N/A'}</td>
                                    <td style="padding: 10px 8px; border: 1px solid #bdc3c7; vertical-align: top;">${shift}</td>
                                    <td style="padding: 10px 8px; border: 1px solid #bdc3c7; vertical-align: top;">${gpsStatus}</td>
                                    <td style="padding: 10px 8px; border: 1px solid #bdc3c7; vertical-align: top; text-align: center;"><span style="color: ${statusColor}; font-weight: bold;">‚úì</span></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function isProfessionalElectricalPlant(name) {
            const electrical = ['elettr', 'gener', 'ups', 'quadr', 'ge', 'mt', 'qe'];
            return electrical.some(keyword => name.toLowerCase().includes(keyword));
        }
        
        function isProfessionalFirePlant(name) {
            const fire = ['antincendio', 'fire', 'ai', 'estintore', 'idrante'];
            return fire.some(keyword => name.toLowerCase().includes(keyword));
        }
        
        function isProfessionalHVACPlant(name) {
            const hvac = ['hvac', 'climatizzazione', 'ventilazione', 'aria', 'condizionamento'];
            return hvac.some(keyword => name.toLowerCase().includes(keyword));
        }
        
        function isProfessionalUPSPlant(name) {
            const ups = ['ups', 'continuit√†', 'batterie', 'alimentazione'];
            return ups.some(keyword => name.toLowerCase().includes(keyword));
        }
        
        function getProfessionalCategoryColor(name) {
            if (isProfessionalElectricalPlant(name)) return '#fff3cd';
            if (isProfessionalFirePlant(name)) return '#f8d7da';
            if (isProfessionalHVACPlant(name)) return '#d1ecf1';
            if (isProfessionalUPSPlant(name)) return '#d4edda';
            return 'transparent';
        }

        // ===== CONFIGURAZIONE AZIENDA =====
        
        function showCompanyConfigModal() {
            const config = getCompanyConfig();
            
            document.getElementById('companyName').value = config.name;
            document.getElementById('companyEmail').value = config.email;
            document.getElementById('companyAddress').value = config.address;
            document.getElementById('companyPhone').value = config.phone;
            document.getElementById('technicalManager').value = config.technicalManager;
            document.getElementById('maintenanceManager').value = config.maintenanceManager;
            
            document.getElementById('companyConfigModal').style.display = 'flex';
        }
        
        function closeCompanyConfigModal() {
            document.getElementById('companyConfigModal').style.display = 'none';
        }
        
        function updateCompanyDisplay() {
            const config = getCompanyConfig();
            
            document.getElementById('displayCompanyName').textContent = config.name;
            document.getElementById('displayTechnicalManager').textContent = config.technicalManager;
            document.getElementById('displayMaintenanceManager').textContent = config.maintenanceManager;
            document.getElementById('displayAddress').textContent = config.address;
            document.getElementById('displayPhone').textContent = config.phone;
            document.getElementById('displayEmail').textContent = config.email;
        }
        
        // Form handler per configurazione azienda
        document.getElementById('companyConfigForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const newConfig = {
                name: document.getElementById('companyName').value.trim(),
                email: document.getElementById('companyEmail').value.trim(),
                address: document.getElementById('companyAddress').value.trim(),
                phone: document.getElementById('companyPhone').value.trim(),
                technicalManager: document.getElementById('technicalManager').value.trim(),
                maintenanceManager: document.getElementById('maintenanceManager').value.trim()
            };
            
            // Gestione logo
            const logoFile = document.getElementById('companyLogo').files[0];
            if (logoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    newConfig.logoData = e.target.result;
                    newConfig.logoName = logoFile.name;
                    updateCompanyConfig(newConfig);
                    updateCompanyDisplay();
                    closeCompanyConfigModal();
                    showSuccess('Configurazione azienda aggiornata con successo');
                };
                reader.readAsDataURL(logoFile);
            } else {
                updateCompanyConfig(newConfig);
                updateCompanyDisplay();
                closeCompanyConfigModal();
                showSuccess('Configurazione azienda aggiornata con successo');
            }
        });
        
        // Aggiorna i registri professionali per usare la configurazione azienda
        function generateProfessionalRegisterHTML(config) {
            const { title, subtitle, icon, color, controls, category, showShifts } = config;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const companyConfig = getCompanyConfig();
            
            // Statistiche
            const totalControls = controls.length;
            const validControls = controls.filter(c => c.location_valid).length;
            const uniqueOperators = new Set(controls.map(c => c.operators?.name)).size;
            const uniquePlants = new Set(controls.map(c => c.technical_rooms?.name || c.tag_id)).size;
            
            // Logo HTML
            const logoHtml = companyConfig.logoData ? 
                `<img src="${companyConfig.logoData}" alt="${companyConfig.logoAlt}" style="max-height: 60px; max-width: 200px; margin-bottom: 10px;">` : 
                `<div style="background: ${color}; color: white; padding: 10px 20px; border-radius: 8px; display: inline-block; margin-bottom: 10px; font-weight: bold;">${companyConfig.name}</div>`;
            
            // Raggruppa per turno se richiesto
            let shiftSections = '';
            if (showShifts) {
                const shifts = {
                    'Mattino (06:00-14:00)': controls.filter(c => {
                        const hour = new Date(c.timestamp).getHours();
                        return hour >= 6 && hour < 14;
                    }),
                    'Pomeriggio (14:00-22:00)': controls.filter(c => {
                        const hour = new Date(c.timestamp).getHours();
                        return hour >= 14 && hour < 22;
                    }),
                    'Notte (22:00-06:00)': controls.filter(c => {
                        const hour = new Date(c.timestamp).getHours();
                        return hour >= 22 || hour < 6;
                    })
                };
                
                shiftSections = Object.entries(shifts).map(([shiftName, shiftControls]) => `
                    <div style="margin-bottom: 2rem; page-break-inside: avoid;">
                        <h3 style="background: ${color}; color: white; padding: 0.75rem; margin: 0; border-radius: 8px;">
                            ${shiftName} - ${shiftControls.length} controlli
                        </h3>
                        ${generateControlsTable(shiftControls)}
                    </div>
                `).join('');
            }
            
            return `
                <div style="font-family: 'Times New Roman', serif; background: white; padding: 40px; line-height: 1.6; color: #2c3e50;">
                    <!-- Header Professionale con Logo -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid ${color}; padding-bottom: 20px;">
                        <div style="flex: 1;">
                            <div style="font-size: 28px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; color: ${color};">
                                ${icon} ${title}
                            </div>
                            <div style="font-size: 16px; color: #7f8c8d; margin-bottom: 5px;">${subtitle}</div>
                            <div style="font-size: 14px; color: #7f8c8d;">
                                Periodo: ${new Date(startDate).toLocaleDateString('it-IT')} - ${new Date(endDate).toLocaleDateString('it-IT')}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            ${logoHtml}
                        </div>
                    </div>
                    
                    <!-- Informazioni Documento -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 5px solid ${color};">
                        <div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #bdc3c7;">
                                <span style="font-weight: bold;">Azienda:</span>
                                <span>${companyConfig.name}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #bdc3c7;">
                                <span style="font-weight: bold;">Responsabile Tecnico:</span>
                                <span>${companyConfig.technicalManager}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #bdc3c7;">
                                <span style="font-weight: bold;">Resp. Manutenzione:</span>
                                <span>${companyConfig.maintenanceManager}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #bdc3c7;">
                                <span style="font-weight: bold;">Documento:</span>
                                <span>${companyConfig.documentPrefix}-${category.toUpperCase()}-${new Date().getFullYear()}</span>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #bdc3c7;">
                                <span style="font-weight: bold;">Data Generazione:</span>
                                <span>${new Date().toLocaleDateString('it-IT')}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #bdc3c7;">
                                <span style="font-weight: bold;">Totale Controlli:</span>
                                <span>${totalControls}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #bdc3c7;">
                                <span style="font-weight: bold;">Controlli Validi:</span>
                                <span style="color: #27ae60; font-weight: bold;">${validControls}/${totalControls}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #bdc3c7;">
                                <span style="font-weight: bold;">Indirizzo:</span>
                                <span style="font-size: 0.9em;">${companyConfig.address}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contenuto Principale -->
                    ${showShifts ? shiftSections : generateControlsTable(controls)}
                    
                    <!-- Sezione Firme -->
                    <div style="margin-top: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                        <div style="text-align: center; padding: 20px; border: 2px solid #bdc3c7; border-radius: 8px;">
                            <strong>RESPONSABILE TECNICO</strong>
                            <div style="border-bottom: 2px solid #2c3e50; height: 40px; margin: 20px 0 10px 0;"></div>
                            <div>${companyConfig.technicalManager}</div>
                            <small>Data: ${new Date().toLocaleDateString('it-IT')}</small>
                        </div>
                        <div style="text-align: center; padding: 20px; border: 2px solid #bdc3c7; border-radius: 8px;">
                            <strong>RESPONSABILE MANUTENZIONE</strong>
                            <div style="border-bottom: 2px solid #2c3e50; height: 40px; margin: 20px 0 10px 0;"></div>
                            <div>${companyConfig.maintenanceManager}</div>
                            <small>Data: ${new Date().toLocaleDateString('it-IT')}</small>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="margin-top: 40px; text-align: center; font-size: 10px; color: #7f8c8d; border-top: 1px solid #bdc3c7; padding-top: 20px;">
                        <p><strong>${companyConfig.footerText}</strong></p>
                        <p>${companyConfig.footerSubtext}</p>
                        <p>Tutti i controlli sono tracciati e verificati con tecnologia NFC e validazione GPS</p>
                    </div>
                </div>
            `;
        }
        
        // Inizializza display azienda al caricamento
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                updateCompanyDisplay();
            }, 100);
        });
    </script>
    
    <script src="api-client.js"></script>
    <script src="config-azienda.js"></script>
</body>
</html>