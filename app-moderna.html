<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>üè≠ Controlli Industriali</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            min-height: 100vh;
            color: #1e293b;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .status {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .status.online {
            background: #dcfce7;
            color: #166534;
        }
        
        .status.offline {
            background: #fef3c7;
            color: #92400e;
        }
        
        .sync-info {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        .main-content {
            padding: 1.5rem;
        }
        
        .operator-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .operator-section:hover {
            background: #f1f5f9;
        }
        
        .operator-info {
            text-align: center;
        }
        
        .operator-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }
        
        .operator-details {
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .scan-section {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .scan-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 1.25rem 2rem;
            border-radius: 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 1rem;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .scan-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.15);
        }
        
        .scan-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .help-button {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        .info-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .info-card h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .info-card p {
            font-size: 0.875rem;
            color: #64748b;
            line-height: 1.4;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        .history-section {
            margin-top: 2rem;
        }
        
        .history-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .history-item h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }
        
        .history-item p {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }
        
        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        
        .success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 350px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal h3 {
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .operator-option {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .operator-option:hover {
            background: #3b82f6;
            color: white;
        }
        
        .operator-option h4 {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .operator-option p {
            font-size: 0.875rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ Controlli Industriali</h1>
            <p>Sistema di controllo impianti tecnici</p>
        </div>

        <div class="status-bar">
            <div id="connectionStatus" class="status offline">üî¥ Connessione...</div>
            <div id="syncInfo" class="sync-info">Sincronizzazione...</div>
        </div>

        <div class="main-content">
            <!-- Sezione Operatore -->
            <div id="operatorSection" class="operator-section" onclick="showOperatorSelection()">
                <div class="operator-info">
                    <div id="operatorDisplay" class="operator-name">üë§ Seleziona Operatore</div>
                    <div class="operator-details">Clicca per scegliere l'operatore</div>
                </div>
            </div>

            <!-- Messaggio di errore/successo -->
            <div id="messageArea"></div>

            <!-- Sezione Scansione -->
            <div class="scan-section">
                <button id="scanButton" class="scan-button" onclick="startNFCScan()">
                    üì± Scansiona Tag NFC
                </button>
                
                <button class="help-button" onclick="showHelp()">
                    ‚ùì Aiuto NFC
                </button>
                
                <button class="help-button" onclick="refreshData()">
                    üîÑ Aggiorna Dati
                </button>
            </div>

            <!-- Statistiche -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div id="todayControls" class="stat-number">-</div>
                    <div class="stat-label">Controlli Oggi</div>
                </div>
                <div class="stat-card">
                    <div id="totalRooms" class="stat-number">-</div>
                    <div class="stat-label">Impianti Totali</div>
                </div>
            </div>

            <!-- Informazioni GPS -->
            <div class="info-card">
                <h3>üìç Posizione GPS</h3>
                <p id="gpsInfo">Rilevamento posizione...</p>
            </div>

            <!-- Ultimo Controllo -->
            <div class="info-card">
                <h3>üïí Ultimo Controllo</h3>
                <p id="lastControl">Nessun controllo effettuato</p>
            </div>

            <!-- Cronologia -->
            <div class="history-section">
                <h3 style="margin-bottom: 1rem; color: #374151;">üìã Cronologia Recente</h3>
                <div id="historyList" class="loading">Caricamento cronologia...</div>
            </div>
        </div>
    </div>

    <!-- Modal Selezione Operatore -->
    <div id="operatorModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>üë• Seleziona Operatore</h3>
            <div id="operatorsList" class="loading">Caricamento operatori...</div>
        </div>
    </div>

    <script src="api-client.js"></script>
    <script src="app-moderna-functions.js"></script>
    <script>
        // Configurazione Supabase - INSERISCI LE TUE CREDENZIALI
        const SUPABASE_URL = 'https://pynodlnwozlyxcfwfqvp.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_C61rsZm3YWmvz82MHGkTAg_RGQQXCL6';
        
        // Variabili globali
        let api;
        let currentOperator = null;
        let currentPosition = null;
        let isOnline = false;
        
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inizializzazione app...');
            try {
                initializeApp();
            } catch (error) {
                console.error('‚ùå Errore inizializzazione:', error);
                alert('Errore inizializzazione app: ' + error.message);
            }
        });
        
        async function initializeApp() {
            console.log('üöÄ Inizializzazione app moderna...');
            
            try {
                // Inizializza API client
                console.log('üì° Inizializzazione API client...');
                api = new ControlsAPI(SUPABASE_URL, SUPABASE_KEY);
                
                // Carica operatore salvato (non dipende da connessione)
                console.log('üë§ Caricamento operatore salvato...');
                loadSavedOperator();
                
                // Avvia GPS (non dipende da connessione)
                console.log('üìç Avvio GPS tracking...');
                startGPSTracking();
                
                // Controlla supporto NFC (non dipende da connessione)
                console.log('üì± Controllo supporto NFC...');
                checkNFCSupport();
                
                // Testa connessione (pu√≤ fallire senza bloccare l'app)
                console.log('üåê Test connessione database...');
                try {
                    await testConnection();
                    
                    // Solo se connesso, carica dati
                    console.log('üìä Caricamento dati iniziali...');
                    await refreshData();
                    
                    // Avvia sync automatica
                    console.log('üîÑ Avvio sync automatica...');
                    startAutoSync();
                } catch (connectionError) {
                    console.warn('‚ö†Ô∏è Connessione database fallita, modalit√† offline:', connectionError);
                    isOnline = false;
                    updateConnectionStatus(false);
                    // L'app continua a funzionare in modalit√† offline
                }
                
                console.log('‚úÖ App inizializzata correttamente');
                
            } catch (error) {
                console.error('‚ùå Errore critico inizializzazione:', error);
                showError('Errore inizializzazione app: ' + error.message);
            }
        }
        
        async function testConnection() {
            try {
                const stats = await api.getStats();
                isOnline = true;
                updateConnectionStatus(true);
                console.log('‚úÖ Connessione Supabase riuscita');
            } catch (error) {
                isOnline = false;
                updateConnectionStatus(false);
                throw new Error('Connessione database fallita');
            }
        }
        
        function updateConnectionStatus(online) {
            const statusElement = document.getElementById('connectionStatus');
            const syncElement = document.getElementById('syncInfo');
            
            if (online) {
                statusElement.className = 'status online';
                statusElement.textContent = 'üü¢ Online';
                syncElement.textContent = 'Sincronizzato';
            } else {
                statusElement.className = 'status offline';
                statusElement.textContent = 'üî¥ Offline';
                syncElement.textContent = 'Non sincronizzato';
            }
        }
        
        async function refreshData() {
            try {
                const stats = await api.getStats();
                
                document.getElementById('todayControls').textContent = stats.todayControls;
                document.getElementById('totalRooms').textContent = stats.totalRooms;
                
                await loadRecentControls();
                
            } catch (error) {
                console.error('Errore caricamento dati:', error);
            }
        }
        
        async function loadRecentControls() {
            try {
                const controls = await api.getRecentControls(5);
                const historyElement = document.getElementById('historyList');
                
                if (controls.length === 0) {
                    historyElement.innerHTML = '<p style="text-align: center; color: #64748b;">Nessun controllo recente</p>';
                    return;
                }
                
                historyElement.innerHTML = controls.map(control => `
                    <div class="history-item">
                        <h4>${control.technical_rooms?.name || control.tag_id}</h4>
                        <p>${control.operators?.name} - ${new Date(control.timestamp).toLocaleString('it-IT')}</p>
                    </div>
                `).join('');
                
                // Aggiorna ultimo controllo
                const lastControl = controls[0];
                document.getElementById('lastControl').textContent = 
                    `${lastControl.technical_rooms?.name || lastControl.tag_id} - ${new Date(lastControl.timestamp).toLocaleString('it-IT')}`;
                
            } catch (error) {
                console.error('Errore caricamento cronologia:', error);
                document.getElementById('historyList').innerHTML = '<p style="color: #ef4444;">Errore caricamento cronologia</p>';
            }
        }
    </script>
</body>
</html>